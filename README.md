# Byndyusoft.Messaging.RabbitMq

Библиотека для работы с RabbitMq. Главные сделанные выборы:

- Получение и публикация сообщений происходит через собственные объекты RabbitMqMessage и ReceivedRabbitMqMessage
- Контент передаётся через `HttpContent`
- Очередь ошибок есть всегда, в случае исключения сохраняется текст исключения
- Встроенная поддержка трассировки
- Встроенная поддержка метрик через активити сурц
- Очереди нужно явно декларировать, для поддержки миграторов

# IRabbtiMqСlient — рабочая лошадка библиотеки

IRabbtiMqСlient вдохновлён HttpClient'ом.

## Работа с сообщениями

- Опустошать очередь
- Получать количество сообщений в очереди
- Получать сообщения из очереди по одному
- Завершать обработку полученного сообщения одним из 4-х возможных исходов
  - Ack
  - NackWithRequeue
  - NackWithoutRequeue
  - Error
- Подписываться на сообщения очереди и возвращать один из 4-х возможных результатов
  - Ack
  - NackWithRequeue
  - NackWithoutRequeue
  - Error
- Публиковать сообщения в очередь

## Работа с топологией

- Создание очереди
- Проверка существования очереди
- Удаление очереди
- Создание обменника
- Проверка существования обменника
- Удаление обменника
- Связывание очереди и обменника

# Клиенты

Библиотекой можно пользоваться "как есть", но лучше использовать отдельные клиенты для каждого сервиса с которым происходит интеграция.

Клиент — инкапсулирует в себе:

- DTO
- название обменников и routing
- логику сериализации/десериализации DTO

## Сценарии, которые должны закрываться с помощью клиентов (пока не всё готово)

(+) Я как создатель сервиса, который владеет контрактом очереди, должен предоставлять клиента для отправки ему сообщений, и подписки на события от него

(-) Я как пользователь клиента могу изменить исходящее сообщение

(+) Я как пользователь клиента могу задавать очередь, через которую получаю события, и её настройки

(+) Я как пользователь клиента могу задать свою стратегию обработки полученных сообщений

(+) Я как создатель клиента, должен понимать, что должно быть в клиенте, а чего не должно быть (название обменников, ключей, дто, формат)

(+) Я как пользователь библиотеки, могу написать клиента для тех случаев, когда его нет по какой либо причине.

(-) Я как пользователь библиотеки, при подписке настраиваю все необходимые для обработки сообщения очереди. Библиотека автоматически создаст всё настроенное при появлении коннекта и пересоздаст при его восстановлении после обрыва

(-) Я как автор клиента имею готовую инфраструктуру для реализации RPC
